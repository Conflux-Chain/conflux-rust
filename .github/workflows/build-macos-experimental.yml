name: Build Conflux (macOS)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Optional git ref to build (tag/commit/branch, e.g. v3.0.2). If empty, builds latest default branch."
        required: false
        type: string
        default: ""
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.ref != '' && github.event.inputs.ref || github.event.repository.default_branch) || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: macos-aarch64
    runs-on: macos-14
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.ref != '' && github.event.inputs.ref || github.event.repository.default_branch) || github.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Compute artifact label
        id: label
        shell: bash
        run: |
          set -euo pipefail

          REF_INPUT="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || '' }}"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${REF_INPUT}" ]]; then
              LABEL="${REF_INPUT}"
            else
              LABEL="$(git rev-parse --short=7 HEAD)"
            fi
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            LABEL="${{ github.ref_name }}"
          else
            LABEL="$(git rev-parse --short=7 HEAD)"
          fi

          LABEL="$(echo "${LABEL}" | sed -E 's#[^A-Za-z0-9._-]+#-#g')"
          LABEL="${LABEL#-}"
          LABEL="${LABEL%-}"

          if [[ -z "${LABEL}" ]]; then
            LABEL="$(git rev-parse --short=7 HEAD)"
          fi

          echo "label=${LABEL}" >> "$GITHUB_OUTPUT"

      - name: Install Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup target add aarch64-apple-darwin

      - name: Install dependencies
        shell: bash
        env:
          HOMEBREW_NO_AUTO_UPDATE: "1"
          HOMEBREW_NO_INSTALL_CLEANUP: "1"
        run: |
          set -euo pipefail
          brew install bzip2

      - name: Build
        shell: bash
        env:
          CMAKE_POLICY_VERSION_MINIMUM: 3.5
        run: |
          set -euo pipefail

          FEATURES="rocksdb/portable"

          RUSTFLAGS="-L $(brew --prefix bzip2)/lib -l bz2" \
            cargo build --release --target aarch64-apple-darwin --features "${FEATURES}"

      - name: Package artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail

          BUILD_PATH="target/aarch64-apple-darwin/release"
          BIN_PATH="${BUILD_PATH}/conflux"
          if [[ ! -f "${BIN_PATH}" ]]; then
            echo "Expected binary not found: ${BIN_PATH}"
            ls -la "${BUILD_PATH}" || true
            exit 1
          fi

          ARCHIVE_NAME="conflux-${{ steps.label.outputs.label }}-macos-aarch64.tar.gz"

          rm -rf packaging_temp dist
          mkdir -p packaging_temp dist

          cp "${BIN_PATH}" packaging_temp/conflux
          cp -R run packaging_temp/run

          tar -C packaging_temp -czf "dist/${ARCHIVE_NAME}" .

          echo "archive=dist/${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"
          echo "archive_name=${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.archive_name }}
          path: ${{ steps.package.outputs.archive }}
          retention-days: 30
