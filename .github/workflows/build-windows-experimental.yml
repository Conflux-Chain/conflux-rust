name: Build Conflux (Windows)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Optional git ref to build (tag/commit/branch, e.g. v3.0.2). If empty, builds latest default branch."
        required: false
        type: string
        default: ""
  push:
    tags:
      - "v*"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.ref != '' && github.event.inputs.ref || github.event.repository.default_branch) || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: windows-x86_64
    runs-on: windows-2022
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.ref != '' && github.event.inputs.ref || github.event.repository.default_branch) || github.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Compute artifact label
        id: label
        shell: bash
        run: |
          set -euo pipefail

          REF_INPUT="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || '' }}"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${REF_INPUT}" ]]; then
              LABEL="${REF_INPUT}"
            else
              LABEL="$(git rev-parse --short=7 HEAD)"
            fi
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            LABEL="${{ github.ref_name }}"
          else
            LABEL="$(git rev-parse --short=7 HEAD)"
          fi

          LABEL="$(echo "${LABEL}" | sed -E 's#[^A-Za-z0-9._-]+#-#g')"
          LABEL="${LABEL#-}"
          LABEL="${LABEL%-}"

          if [[ -z "${LABEL}" ]]; then
            LABEL="$(git rev-parse --short=7 HEAD)"
          fi

          echo "label=${LABEL}" >> "$GITHUB_OUTPUT"

      - name: Install common dependencies
        shell: bash
        run: |
          set -euo pipefail
          choco install llvm -y

      - name: Install Rust toolchain
        shell: bash
        run: |
          set -euo pipefail
          rustup target add x86_64-pc-windows-msvc

      - name: Install OpenSSL (static)
        shell: bash
        run: |
          set -euo pipefail

          vcpkg install openssl:x64-windows-static-md

          echo "OPENSSL_STATIC=1" >> "$GITHUB_ENV"
          echo "VCPKG_TARGET_TRIPLET=x64-windows-static-md" >> "$GITHUB_ENV"
          echo "VCPKG_ROOT=$VCPKG_INSTALLATION_ROOT" >> "$GITHUB_ENV"

      - name: Build
        shell: bash
        env:
          RUSTFLAGS: "-C target-cpu=haswell"
        run: |
          set -euo pipefail

          FEATURES="rocksdb/portable"

          cargo build --release --target x86_64-pc-windows-msvc --features "${FEATURES}"

      - name: Package artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail

          BUILD_PATH="target/x86_64-pc-windows-msvc/release"
          BIN_PATH="${BUILD_PATH}/conflux.exe"
          if [[ ! -f "${BIN_PATH}" ]]; then
            echo "Expected binary not found: ${BIN_PATH}"
            ls -la "${BUILD_PATH}" || true
            exit 1
          fi

          ARCHIVE_NAME="conflux-${{ steps.label.outputs.label }}-windows-x86_64.zip"

          rm -rf packaging_temp dist
          mkdir -p packaging_temp dist

          cp "${BIN_PATH}" packaging_temp/conflux.exe
          cp -R run/. packaging_temp/

          if ! command -v 7z >/dev/null 2>&1; then
            echo "7z not found; cannot create zip archive on Windows runner."
            exit 1
          fi

          pushd packaging_temp >/dev/null
          7z a -tzip "../dist/${ARCHIVE_NAME}" ./* >/dev/null
          popd >/dev/null

          echo "archive=dist/${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"
          echo "archive_name=${ARCHIVE_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.archive_name }}
          path: ${{ steps.package.outputs.archive }}
          retention-days: 30
